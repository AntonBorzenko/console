import {PanelCtrl} from 'app/plugins/sdk';
import moment from 'moment';
import './external/moment-duration-format';
import _ from 'lodash';
import './css/clock-panel.css!';

const panelDefaults = {
  mode: 'time',
  clockType: '24 hour',
  offsetFromUtc: null,
  offsetFromUtcMinutes: null,
  bgColor: null,
  countdownSettings: {
    endCountdownTime: moment().seconds(0).milliseconds(0).add(1, 'day').toDate(),
    endText: '00:00:00',
    customFormat: null
  },
  dateSettings: {
    showDate: false,
    dateFormat: 'YYYY-MM-DD',
    fontSize: '20px',
    fontWeight: 'normal'
  },
  timeSettings: {
    customFormat: 'HH:mm:ss',
    fontSize: '60px',
    fontWeight: 'normal'
  }
};

export class ClockCtrl extends PanelCtrl {
  constructor($scope, $injector) {
      super($scope, $injector);
      _.defaultsDeep(this.panel, panelDefaults);

      if (!(this.panel.countdownSettings.endCountdownTime instanceof Date)) {
	  this.panel.countdownSettings.endCountdownTime = moment(this.panel.countdownSettings.endCountdownTime).toDate();
      }
      
      this.events.on('init-edit-mode', this.onInitEditMode.bind(this));
      this.events.on('panel-teardown', this.onPanelTeardown.bind(this));
      this.events.on('panel-initialized', this.render.bind(this));
      
      function readTextFile(file)
      {
	  var rawFile = new XMLHttpRequest();
	  var allText = null;
	  rawFile.open("GET", file, false);
	  rawFile.onreadystatechange = function ()
	  {
	      alert(rawFile.status);
              if(rawFile.readyState === 4)
              {
		  if(rawFile.status === 200 || rawFile.status == 0)
		  {
                      allText = rawFile.responseText;
		  }
              }
	  }
	  rawFile.send(null);
	  return allText;
      }
      
      var jsonContent = readTextFile("data.json");
      jsonContent = {"status":"success","data":{"resultType":"matrix","result":[{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"+Inf"},"values":[[1539529920,"1"],[1539530640,"1"],[1539531000,"2"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"100"},"values":[[1539529920,"0"],[1539530640,"0"],[1539531000,"0"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"1000"},"values":[[1539529920,"0"],[1539530640,"0"],[1539531000,"0"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"10000"},"values":[[1539529920,"1"],[1539530640,"1"],[1539531000,"2"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"100000"},"values":[[1539529920,"1"],[1539530640,"1"],[1539531000,"2"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"1e+06"},"values":[[1539529920,"1"],[1539530640,"1"],[1539531000,"2"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"1e+07"},"values":[[1539529920,"1"],[1539530640,"1"],[1539531000,"2"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"1e+08"},"values":[[1539529920,"1"],[1539530640,"1"],[1539531000,"2"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/label/:name/values","instance":"localhost:9090","job":"prometheus","le":"1e+09"},"values":[[1539529920,"1"],[1539530640,"1"],[1539531000,"2"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"+Inf"},"values":[[1539529920,"53"],[1539530640,"179"],[1539531000,"229"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"100"},"values":[[1539529920,"0"],[1539530640,"0"],[1539531000,"0"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"1000"},"values":[[1539529920,"0"],[1539530640,"0"],[1539531000,"0"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"10000"},"values":[[1539529920,"53"],[1539530640,"179"],[1539531000,"229"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"100000"},"values":[[1539529920,"53"],[1539530640,"179"],[1539531000,"229"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"1e+06"},"values":[[1539529920,"53"],[1539530640,"179"],[1539531000,"229"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"1e+07"},"values":[[1539529920,"53"],[1539530640,"179"],[1539531000,"229"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"1e+08"},"values":[[1539529920,"53"],[1539530640,"179"],[1539531000,"229"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/metrics","instance":"localhost:9090","job":"prometheus","le":"1e+09"},"values":[[1539529920,"53"],[1539530640,"179"],[1539531000,"229"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"+Inf"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"100"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"1000"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"10000"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"100000"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"1e+06"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"1e+07"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"1e+08"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query","instance":"localhost:9090","job":"prometheus","le":"1e+09"},"values":[[1539529920,"6"],[1539530640,"6"],[1539531000,"12"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"+Inf"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"100"},"values":[[1539529920,"7"],[1539530640,"7"],[1539531000,"15"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"1000"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"10000"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"100000"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"1e+06"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"1e+07"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"1e+08"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]},{"metric":{"__name__":"prometheus_http_response_size_bytes_bucket","handler":"/query_range","instance":"localhost:9090","job":"prometheus","le":"1e+09"},"values":[[1539529920,"11"],[1539530640,"11"],[1539531000,"19"]]}]}}

      //JSON.parse(jsonContent);
     // alert(jsonContent);
      var data = jsonContent['data'];
      var result = data['result'];
      
      var svg = document.createElement("svg");
      //var svgdiv = document.getElementById("svgdiv");
      //alert(document.body.innerHTML);
      //svgdiv.appendChild(svg);
      
      svg.setAttribute("width", 200);
      svg.setAttribute("height", 200);
      
      function doForEachMetrics(metrics) {
	  var values = metrics['values'];
	  var startTime = values[0][0];
	  
	  var x = [];
	  var y = [];
	  
	  function doForEachValuePair(value) {
              x.push(value[0] - startTime);
              y.push(value[1]);
	  }
	  
	  values.forEach(doForEachValuePair);
	  
	  var polyline = document.createElement("polyline");
	  svg.appendChild(polyline);
	  
	  var pts = "";
	  for (var i = 0; i < x.length; ++i) {
              pts += x[i].toString() + ",";
              pts += y[i].toString() + " ";
	  }
	  polyline.setAttribute("points", pts);
	  
	  polyline.setAttribute("style", "fill:none;stroke:black;stroke-width:3");
      }
      
      result.forEach(doForEachMetrics);
      //var elem = document.getElementById("svgdiv");
      //alert(document.outerHTML);
      //var svgdiv = $(".svgdiv");
      //alert(svgdiv.data());
      //svgdiv.append(svg.outerHTML);
      this.svg = svg.outerHTML.toString();
      
  }
    
    onInitEditMode() {
	this.addEditorTab('Options', 'public/plugins/grafana-clock-panel/editor.html', 2);
    }

    onPanelTeardown() {
	this.$timeout.cancel(this.nextTickPromise);
    }
    
}

ClockCtrl.templateUrl = 'module.html';
